# WEB服务器

## 实验环境

Ubuntu 18.04


## 安装配置步骤

### Nginx


```bash
# 安装nginx
sudo apt-get install nginx -y
# 验证是否安装成功
sudo nginx -t
```



### VeryNginx

```bash 
# nginx安装完成之后会自动启动，我们先关掉
sudo nginx -s stop
# 安装所需程序
sudo apt install -y libpcre3-dev libssl1.0-dev zlib1g-dev python3 unzip gcc make
# 下载并解压verynginx安装包
wget https://github.com/alexazhou/VeryNginx/archive/master.zip
unzip master.zip
cd VeryNginx-master/
#修改nginx.conf , 将第二行的user设置为www-data
sed -i "2s/nginx/www-data/" nginx.conf
#安装verynginx
sudo python3 install.py install
#安装完之后，每次启动verynginx都要执行/opt/verynginx/openresty/nginx/sbin/nginx
#这里学习'MasterofMagic'，创建软链接
sudo ln -s /opt/verynginx/openresty/nginx/sbin/nginx /usr/sbin/verynginx
#检查配置是否ok，如果可以，显示的结果如下
# nginx: the configuration file /opt/verynginx/openresty/nginx/conf/nginx.conf syntax is ok
# nginx: configuration file /opt/verynginx/openresty/nginx/conf/nginx.conf test is successful
#启动verynginx
sudo verynginx
```
![安装成功](images/1.jpg)

访问verynginx配置界面，`vn.sec.cuc.edu.cn/verynginx/index.html`账号如下

```
username=verynginx
password=verynginx
```
登录成功，界面如下

![登录成功](images/2.jpg)

### WordPress

```bash
# WordPress需要用到数据库，所以我们要用mysql创建WordPress所需要的库
# 下载安装mysql和php7.2相关软件
sudo apt install -y mysql-server php7.2-fpm php7.2-mysql php7.2-gd
# 安装完成后进入root用户
# mysql root 用户默认没有密码
sudo mysql -u root -p
# 进入mysql后之后，创建WordPress使用的数据库

mysql> CREATE USER 'wordpress'@'localhost' IDENTIFIED BY 'wordpress';
mysql> CREATE DATABASE wp_db;
mysql> GRANT ALL ON wp_db.* TO 'wordpress'@'localhost';
# 指定WorePress目录
WP_PATH=/var/www/wordpress
# 创建该目录下的public文件夹
sudo mkdir -p ${WP_PATH}/public/
# 修改该文件下的所有者为www-data
sudo chown -R www-data:www-data ${WP_PATH}/public
# 下载并解压WorePress
wget https://wordpress.org/wordpress-4.7.zip
unzip wordpress-4.7.zip
# 将wordpress文件全部拷贝刚才的public中
sudo cp -r wordpress/* ${WP_PATH}/public/
cd ${WP_PATH}/public/
# 拷贝配置文件
sudo cp wp-config-sample.php wp-config.php
# 修改wp-config.php文件中的`database_name_here`,`username_here`和`password_here`字段为我们的数据库名称，用户名和密码。使wordpress能够访问mysql。
sudo sed -i s/database_name_here/wp_db/ wp-config.php
sudo sed -i s/username_here/wordpress/ wp-config.php
sudo sed -i s/password_here/wordpress/ wp-config.php
```

### 连接WordPress与Nginx

```bash
# 新建配置文件，设置端口8080和文件名wp.sec.cuc.edu.cn
WP_DOMAIN=wp.sec.cuc.edu.cn
WP_PORT=8080
sudo tee /etc/nginx/sites-available/${WP_DOMAIN} << EOF
server {
    listen localhost:${WP_PORT};
    server_name ${WP_DOMAIN};

    root ${WP_PATH}/public;
    index index.php;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.2-fpm.sock;
    }
}
EOF
# 在sites-enabled中创建sites-available的软链接，并删除default
sudo ln -s /etc/nginx/sites-available/${WP_DOMAIN} /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
# 启动nginx
sudo nginx
```

### 配置VeryNginx访问wp.sec.cuc.edu.cn

**添加匹配规则**

![](images/3.jpg)

**添加Up Stream节点**
**添加Proxy Pass规则**
![](images/4.jpg)




然后访问`wp.sec.cuc.edu.cn`就可以自动进入安装界面了，安装过程中可以设置博客Tittle，用户名，密码，邮箱等

![](images/5.jpg)

安装完成后，进入管理页面，这就配置好了

![](images/6.jpg)


### 安装Dvwa并配置VeryNginx

**与WordPress步骤类似**

```bash
# 指定目录，更改所有者
DVWA_PATH=/var/www/dvwa
sudo mkdir -p ${DVWA_PATH}/public/
sudo chown -R www-data:www-data ${DVWA_PATH}/public

# 下载解压
wget https://github.com/ethicalhack3r/DVWA/archive/master.zip
unzip master.zip
# 拷贝文件到/var/www/dvwa下
sudo cp -r DVWA-master/* ${DVWA_PATH}/public/
cd ${DVWA_PATH}/public/
sudo cp config/config.inc.php.dist config/config.inc.php
# 配置文件,8000端口
DVWA_DOMAIN=dvwa.sec.cuc.edu.cn
DVWA_PORT=8000
sudo tee /etc/nginx/sites-available/${DVWA_DOMAIN} << EOF
server {
    listen localhost:${DVWA_PORT};
    server_name ${DVWA_DOMAIN};

    root ${DVWA_PATH}/public;
    index index.php;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.2-fpm.sock;
    }
}
EOF
# 设置软链接
sudo ln -s /etc/nginx/sites-available/${DVWA_DOMAIN} /etc/nginx/sites-enabled/
# 重新载入配置
sudo nginx -s reload
```

**添加匹配规则**

![](images/7.jpg)

**添加Up Stream节点**

![](images/8.jpg)

**添加Proxy Pass 规则**

![](images/9.jpg)

保存后访问`dvwa.sec.cuc.edu.cn`就能看到如下页面了

![](images/10.jpg)

### WordPress启用HTTPS



```bash
# 生成自签名证书
sudo openssl req -x509 -newkey rsa:4096 -nodes -subj "/C=CN/ST=Beijing/L=Beijing/O=CUC/OU=SEC/CN=wp.sec.cuc.edu.cn" -keyout key.pem -out cert.pem -days 365
# 将生成的cert.pem和key.pem放在/etc/nginx目录下
sudo mv cert.pem /etc/nginx/
sudo mv key.pem /etc/nginx/
# 修改/etc/nginx/sites-available/wp.sec.cuc.edu.cn 中的8080端口为”8443 ssl"
sudo sed -i "2s/8080/8443\ ssl" wp.sec.cuc.edu.cn
# 在第二行后添加cert.pem和key.pem
sudo sed -i '2a ssl_certificate      /etc/nginx/cert.pem;\nssl_certificate_key  /etc/nginx/key.pem;' wp.sec.cuc.edu.cn
```

在`/opt/verynginx/openresty/nginx/conf/nginx.conf`中修改server块，使verynginx监听443端口

```bash
server {
    listen 80;
    listen 443 ssl;
    ssl_certificate      /etc/nginx/cert.pem;
    ssl_certificate_key  /etc/nginx/key.pem;

    #this line shoud be include in every server block
    include /opt/verynginx/verynginx/nginx_conf/in_server_block.conf;

    location = / {
        root   html;
        index  index.html index.htm;
    }
}
```
**重新加载配置文件**

```bash
sudo nginx -s reload
sudo verynginx -s reload
```

由于刚才改了nginx对wordpress的配置文件，所以要重新去verynginx中设置一下

![](images/11.jpg)




## 安全加固

### 使用IP地址方式均无法访问上述任意站点，并向访客展示自定义的友好错误提示信息页面-1


**添加`Matcher`规则**

![](images/12.png)

**添加`Response`相应**

![](images/13.png)

**添加`Filter`**

![](images/14.png)

此时以ip形式访问，会出现对应的提示并拒绝

![](images/15.png)


### Damn Vulnerable Web Application (DVWA)只允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-2

**添加`Matcher`**

![](images/16.png)

**添加`Response`**

![](images/17.png)

**添加`Filter`**

![](images/18.png)

**在白名单的客户端访问**

![](images/19.png)

**不在白名单的客户端访问**

![](images/20.png)


### 在不升级Wordpress版本的情况下，通过定制VeryNginx的访问控制策略规则，热修复WordPress < 4.7.1 - Username Enumeration



**添加`^/wp-json/wp/v2/users.*`匹配和filter，拒绝即可**

![](images/21.png)

![](images/22.png)

![](images/23.png)


### 通过配置VeryNginx的Filter规则实现对Damn Vulnerable Web Application (DVWA)的SQL注入实验在低安全等级条件下进行防护

**简单过滤一下提交参数**

![](images/24.png)

![](images/25.png)

### VeryNginx的Web管理页面仅允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-3

与其他两个类似

**添加`Matcher`**

![](images/26.png)


![](images/27.png)

**添加`Response`**

![](images/28.png)

**添加`Filter`，顺序很重要**

![](images/29.png)

**白名单访问**

![](images/30.png)

**非白名单访问**

![](images/31.png)








### 限制DVWA站点的单IP访问速率为每秒请求数 < 50, 限制Wordpress站点的单IP访问速率为每秒请求数 < 20, 超过访问频率限制的请求直接返回自定义错误提示信息页面-4

**添加`Response`**

![](images/32.png)

**添加`Frequency Limit`**

![](images/33.png)

**进行压测**

![](images/34.png)


## [参考资料](https://github.com/CUCCS/linux-2020-WOC-BUG/blob/0x05/0x05/%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9AWeb%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E5%AE%9E%E9%AA%8C%EF%BC%89.md)


